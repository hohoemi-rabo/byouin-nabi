# 011 - AIè¨ºæ–­æ©Ÿèƒ½å®Ÿè£…ï¼ˆå®Ÿé¨“çš„ï¼‰

## æ¦‚è¦
OpenAI APIã‚’ä½¿ç”¨ã—ãŸç—‡çŠ¶ã®AIåˆ†ææ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
**æ³¨æ„**: ã“ã®æ©Ÿèƒ½ã¯å®Ÿé¨“çš„ã§ã€åˆæœŸãƒªãƒªãƒ¼ã‚¹æ™‚ã¯ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚

## ç›®çš„
- ç—‡çŠ¶ã«åŸºã¥ãAIåˆ†æã®æä¾›
- å—è¨ºã®ç·Šæ€¥åº¦ã®ç›®å®‰ã‚’æç¤º
- æ¨å¥¨è¨ºç™‚ç§‘ã®ææ¡ˆ

## ã‚¿ã‚¹ã‚¯

### OpenAI SDK å°å…¥
- [ ] openai ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
- [ ] /api/symptoms/ai-diagnosis ä½œæˆ
- [ ] OpenAI API ã¨ã®é€£æº
- [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å®Ÿè£…
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†

### ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹åˆ¶å¾¡
- [ ] NEXT_PUBLIC_AI_DIAGNOSIS ãƒ•ãƒ©ã‚°ã®å®Ÿè£…
- [ ] æœ¬ç•ªç’°å¢ƒã§ã¯ false è¨­å®š
- [ ] é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿ true

### UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] AIDiagnosisButton ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] AIDiagnosisResult ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] å…è²¬äº‹é …ã®å¼·èª¿è¡¨ç¤º
- [ ] Loading çŠ¶æ…‹ã®è¡¨ç¤º

### å…è²¬äº‹é …ã®å®Ÿè£…
- [ ] ã€Œå®Ÿé¨“çš„æ©Ÿèƒ½ã€ã®æ˜ç¤º
- [ ] ã€ŒåŒ»å­¦çš„è¨ºæ–­ã§ã¯ãªã„ã€ã®å¼·èª¿
- [ ] ã€Œå¿…ãšåŒ»å¸«ã®è¨ºå¯Ÿã‚’ã€ã®è¡¨ç¤º

## å®Ÿè£…ä¾‹

```typescript
// src/app/api/symptoms/ai-diagnosis/route.ts
import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const AI_ENABLED = process.env.NEXT_PUBLIC_AI_DIAGNOSIS === 'true';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  // æ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  if (!AI_ENABLED) {
    return NextResponse.json(
      { error: 'AIè¨ºæ–­æ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“' },
      { status: 403 }
    );
  }

  try {
    const body = await request.json();
    const { location, duration, symptoms, conditions, medicine, memo } = body;

    const prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªåŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®ç—‡çŠ¶æƒ…å ±ã‹ã‚‰ã€å¯èƒ½æ€§ã®ã‚ã‚‹ç–¾æ‚£ã‚„å—è¨ºã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€ç—‡çŠ¶æƒ…å ±ã€‘
- éƒ¨ä½: ${location}
- æœŸé–“: ${duration}
- ç—‡çŠ¶: ${symptoms.join('ã€')}
- æŒç—…: ${conditions.join('ã€') || 'ãªã—'}
- æœè–¬: ${medicine}
- ãƒ¡ãƒ¢: ${memo || 'ãªã—'}

ã€å›ç­”å½¢å¼ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

â—†è€ƒãˆã‚‰ã‚Œã‚‹å¯èƒ½æ€§ï¼ˆ3ã¤ã¾ã§ï¼‰
1. ...
2. ...
3. ...

â—†ç·Šæ€¥åº¦ï¼š[é«˜/ä¸­/ä½]
- [ç·Šæ€¥åº¦ã®èª¬æ˜]

â—†æ¨å¥¨è¨ºç™‚ç§‘
- [è¨ºç™‚ç§‘å]

â—†å—è¨ºæ™‚ã®æ³¨æ„ç‚¹
- [æ³¨æ„ç‚¹1]
- [æ³¨æ„ç‚¹2]

â—†æ—¥å¸¸ç”Ÿæ´»ã§ã®ã‚±ã‚¢
- [ã‚±ã‚¢æ–¹æ³•1]
- [ã‚±ã‚¢æ–¹æ³•2]

é‡è¦ï¼šã“ã‚Œã¯åŒ»å­¦çš„è¨ºæ–­ã§ã¯ãªãã€å‚è€ƒæƒ…å ±ã§ã™ã€‚`;

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.7,
      max_tokens: 1000,
    });

    const analysis = completion.choices[0].message.content;

    return NextResponse.json({ analysis });
  } catch (error) {
    console.error('AI diagnosis error:', error);
    return NextResponse.json(
      { error: 'AIè¨ºæ–­ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

```typescript
// src/components/SymptomResult/AIDiagnosisButton.tsx
'use client';

import { useState } from 'react';

const AI_ENABLED = process.env.NEXT_PUBLIC_AI_DIAGNOSIS === 'true';

export default function AIDiagnosisButton({ questionnaireData }: any) {
  const [analysis, setAnalysis] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [agreed, setAgreed] = useState(false);

  if (!AI_ENABLED) {
    return null; // æ©Ÿèƒ½ãŒç„¡åŠ¹ã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
  }

  const handleAnalyze = async () => {
    if (!agreed) {
      alert('å…è²¬äº‹é …ã«åŒæ„ã—ã¦ãã ã•ã„');
      return;
    }

    setIsLoading(true);
    try {
      const response = await fetch('/api/symptoms/ai-diagnosis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(questionnaireData),
      });

      if (!response.ok) {
        throw new Error('AIè¨ºæ–­ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      setAnalysis(data.analysis);
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="mt-8 border-t pt-8">
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <h3 className="text-xl font-bold text-yellow-800 mb-3">
          ğŸ§ª AIè¨ºæ–­ï¼ˆå®Ÿé¨“çš„æ©Ÿèƒ½ï¼‰
        </h3>

        <div className="bg-white border-2 border-red-500 rounded p-4 mb-4">
          <p className="text-red-600 font-bold text-lg mb-2">
            âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …
          </p>
          <ul className="text-sm space-y-1 text-red-600">
            <li>â€¢ ã“ã‚Œã¯AIã«ã‚ˆã‚‹åˆ†æã§ã‚ã‚Šã€åŒ»å­¦çš„è¨ºæ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
            <li>â€¢ ã“ã®æ©Ÿèƒ½ã¯å®Ÿé¨“çš„ã§ã€ãƒ†ã‚¹ãƒˆæ®µéšã§ã™</li>
            <li>â€¢ å¿…ãšåŒ»å¸«ã®è¨ºå¯Ÿã‚’å—ã‘ã¦ãã ã•ã„</li>
            <li>â€¢ ç·Šæ€¥æ™‚ã¯119ç•ªé€šå ±ã—ã¦ãã ã•ã„</li>
          </ul>
        </div>

        <label className="flex items-center mb-4">
          <input
            type="checkbox"
            checked={agreed}
            onChange={(e) => setAgreed(e.target.checked)}
            className="mr-2"
          />
          <span className="text-sm">
            ä¸Šè¨˜ã®æ³¨æ„äº‹é …ã‚’ç†è§£ã—ã€å‚è€ƒæƒ…å ±ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™
          </span>
        </label>

        <button
          onClick={handleAnalyze}
          disabled={!agreed || isLoading}
          className="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 disabled:opacity-50"
        >
          {isLoading ? 'AIåˆ†æä¸­...' : 'ğŸ¤– AIè¨ºæ–­ã‚’è©¦ã™'}
        </button>
      </div>

      {analysis && (
        <div className="mt-6 bg-white border rounded-lg p-6">
          <h4 className="font-bold text-lg mb-3">AIåˆ†æçµæœ</h4>
          <div className="whitespace-pre-wrap">{analysis}</div>
          <p className="mt-4 text-sm text-red-600 font-bold">
            â€» ã“ã®åˆ†æã¯å‚è€ƒæƒ…å ±ã§ã™ã€‚å¿…ãšåŒ»å¸«ã®è¨ºå¯Ÿã‚’å—ã‘ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      )}
    </div>
  );
}
```

## ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env.localï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
OPENAI_API_KEY=sk-...
NEXT_PUBLIC_AI_DIAGNOSIS=true

# .env.productionï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
# OPENAI_API_KEY=ï¼ˆè¨­å®šã—ãªã„ï¼‰
NEXT_PUBLIC_AI_DIAGNOSIS=false
```

## package.json è¿½åŠ 

```json
{
  "dependencies": {
    "openai": "^4.77.3"
  }
}
```

## å—ã‘å…¥ã‚ŒåŸºæº–
- [ ] é–‹ç™ºç’°å¢ƒã§AIè¨ºæ–­ãŒå‹•ä½œã™ã‚‹
- [ ] æœ¬ç•ªç’°å¢ƒã§ã¯ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„
- [ ] å…è²¬äº‹é …ãŒæ˜ç¢ºã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæ„ãŒå¿…é ˆã§ã‚ã‚‹
- [ ] AIåˆ†æçµæœãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ç’°å¢ƒå¤‰æ•°ã§æ©Ÿèƒ½ã®ON/OFFãŒã§ãã‚‹

## ä¾å­˜é–¢ä¿‚
- 004-ç—‡çŠ¶èª¬æ˜æ–‡ç”Ÿæˆæ©Ÿèƒ½

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `/home/masayuki/NextJs/byouin-nabi/src/app/api/symptoms/ai-diagnosis/route.ts`
- `/home/masayuki/NextJs/byouin-nabi/src/components/SymptomResult/AIDiagnosisButton.tsx`
- `/home/masayuki/NextJs/byouin-nabi/.env.local`
- `/home/masayuki/NextJs/byouin-nabi/.env.production`

## å‚™è€ƒ
- **åˆæœŸãƒªãƒªãƒ¼ã‚¹æ™‚ã¯å¿…ãšç„¡åŠ¹åŒ–**
- æ³•å‹™ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã«æœ‰åŠ¹åŒ–ã‚’æ¤œè¨
- APIåˆ©ç”¨æ–™é‡‘ã«æ³¨æ„ï¼ˆgpt-4o-miniã‚’ä½¿ç”¨ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…ãŒå¿…è¦
- å°†æ¥çš„ã«ã¯ã‚ˆã‚Šè©³ç´°ãªåˆ†ææ©Ÿèƒ½ã‚’è¿½åŠ äºˆå®š
