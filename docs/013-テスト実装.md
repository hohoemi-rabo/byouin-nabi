# 013 - テスト実装

## 概要
重要な機能に対するユニットテスト・統合テストを実装します。

## 目的
- コア機能の品質保証
- リグレッションの防止
- リファクタリングの安全性確保

## タスク

### テスト環境セットアップ
- [ ] Vitest のインストール
- [ ] React Testing Library のインストール
- [ ] @testing-library/jest-dom のインストール
- [ ] vitest.config.ts の作成
- [ ] setupTests.ts の作成

### ユニットテスト実装
- [ ] 症状説明文生成関数のテスト
- [ ] 診療科マッピング関数のテスト
- [ ] バリデーション関数のテスト
- [ ] ユーティリティ関数のテスト

### コンポーネントテスト
- [ ] Button コンポーネントのテスト
- [ ] QuestionOption コンポーネントのテスト
- [ ] HospitalCard コンポーネントのテスト

### 統合テスト（E2E）
- [ ] Playwright のインストール
- [ ] アンケートフローのテスト
- [ ] 病院検索フローのテスト
- [ ] 管理画面フローのテスト

## 実装例

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    globals: true,
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

```typescript
// src/test/setup.ts
import '@testing-library/jest-dom';
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

expect.extend(matchers);

afterEach(() => {
  cleanup();
});
```

```typescript
// src/lib/__tests__/generateSymptomDescription.test.ts
import { describe, it, expect } from 'vitest';
import { generateSymptomDescription } from '../generateSymptomDescription';

describe('generateSymptomDescription', () => {
  it('should generate symptom description with all fields', () => {
    const data = {
      location: 'のど',
      duration: '今日',
      symptoms: ['痛い', '熱がある'],
      conditions: ['なし'],
      medicine: 'のんでいない',
      memo: 'つばを飲むと痛い',
    };

    const result = generateSymptomDescription(data);

    expect(result).toContain('のどが気になります');
    expect(result).toContain('痛い、熱がある');
    expect(result).toContain('今日');
    expect(result).toContain('つばを飲むと痛い');
    expect(result).toContain('必ず医師の診察を受けてください');
  });

  it('should handle empty symptoms array', () => {
    const data = {
      location: 'あたま',
      duration: '2〜3日前',
      symptoms: [],
      conditions: ['血圧・心臓'],
      medicine: 'のんでいる',
      memo: '',
    };

    const result = generateSymptomDescription(data);

    expect(result).toContain('あたまが気になります');
    expect(result).toContain('2〜3日前');
    expect(result).toContain('血圧・心臓');
  });
});
```

```typescript
// src/lib/__tests__/departmentMapping.test.ts
import { describe, it, expect } from 'vitest';
import { getDepartments } from '../departmentMapping';

describe('getDepartments', () => {
  it('should return correct departments for のど', () => {
    const result = getDepartments('のど', []);
    expect(result).toEqual(['耳鼻咽喉科', '内科']);
  });

  it('should prioritize 内科 for emergency symptoms', () => {
    const result = getDepartments('のど', ['息がしづらい']);
    expect(result[0]).toBe('内科');
  });

  it('should return 内科 for わからない', () => {
    const result = getDepartments('わからない', []);
    expect(result).toEqual(['内科']);
  });

  it('should return 皮膚科 for skin symptoms', () => {
    const result = getDepartments('かわ（皮ふ）', []);
    expect(result).toContain('皮膚科');
  });
});
```

```typescript
// src/components/Common/__tests__/Button.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import Button from '../Button';

describe('Button', () => {
  it('should render with children', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('should call onClick when clicked', async () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Click me</Button>);

    await userEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('should apply primary variant styles', () => {
    render(<Button variant="primary">Primary</Button>);
    const button = screen.getByText('Primary');
    expect(button).toHaveClass('bg-primary');
  });

  it('should be disabled when disabled prop is true', () => {
    render(<Button disabled>Disabled</Button>);
    const button = screen.getByText('Disabled');
    expect(button).toBeDisabled();
  });

  it('should have minimum tap area of 48px', () => {
    render(<Button>Tap me</Button>);
    const button = screen.getByText('Tap me');
    expect(button).toHaveClass('min-h-[48px]');
    expect(button).toHaveClass('min-w-[48px]');
  });
});
```

```typescript
// e2e/questionnaire.spec.ts (Playwright)
import { test, expect } from '@playwright/test';

test.describe('Questionnaire Flow', () => {
  test('should complete questionnaire and view results', async ({ page }) => {
    await page.goto('/');

    // ホームページから開始
    await page.click('text=症状から病院を探す');

    // Q1: どこが気になりますか？
    await page.click('text=のど');

    // Q2: いつからですか？
    await page.click('text=今日');

    // Q3: どんな状態ですか？
    await page.click('text=痛い');
    await page.click('text=熱がある');

    // Q5: 持病
    await page.click('text=なし');

    // Q6: 薬
    await page.click('text=のんでいない');

    // まとめボタン
    await page.click('text=まとめる');

    // 結果ページの確認
    await expect(page).toHaveURL(/.*results/);
    await expect(page.locator('text=のどが気になります')).toBeVisible();
    await expect(page.locator('text=耳鼻咽喉科')).toBeVisible();
  });
});
```

## package.json 追加

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test"
  },
  "devDependencies": {
    "vitest": "^2.1.8",
    "@vitejs/plugin-react": "^4.3.4",
    "@testing-library/react": "^16.1.0",
    "@testing-library/jest-dom": "^6.6.3",
    "@testing-library/user-event": "^14.5.2",
    "@playwright/test": "^1.49.1",
    "@vitest/ui": "^2.1.8",
    "@vitest/coverage-v8": "^2.1.8"
  }
}
```

## 受け入れ基準
- [ ] 全てのユニットテストが通過する
- [ ] カバレッジが70%以上
- [ ] コアロジックのテストが網羅されている
- [ ] 主要なユーザーフローのE2Eテストが通過する
- [ ] CI/CDで自動実行される

## 依存関係
- 004-症状説明文生成機能
- 005-診療科マッピング機能

## 関連ファイル
- `/home/masayuki/NextJs/byouin-nabi/vitest.config.ts`
- `/home/masayuki/NextJs/byouin-nabi/src/test/setup.ts`
- `/home/masayuki/NextJs/byouin-nabi/src/lib/__tests__/`
- `/home/masayuki/NextJs/byouin-nabi/src/components/**/__tests__/`
- `/home/masayuki/NextJs/byouin-nabi/e2e/`

## 備考
- テストは継続的に追加・改善
- カバレッジ100%は目指さない（コストパフォーマンス重視）
- E2Eテストは主要フローのみ（保守コスト考慮）
