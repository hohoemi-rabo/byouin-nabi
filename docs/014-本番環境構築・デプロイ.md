# 014 - 本番環境構築・デプロイ

## 概要
Vercelへのデプロイと本番環境の構築を行います。

## 目的
- 本番環境の構築
- 継続的デプロイの設定
- ドメイン設定

## タスク

### Vercel プロジェクト作成
- [ ] Vercel アカウント作成
- [ ] GitHubリポジトリ連携
- [ ] プロジェクトのインポート
- [ ] ビルド設定の確認

### 環境変数設定
- [ ] Supabase 環境変数の設定
  - [ ] NEXT_PUBLIC_SUPABASE_URL
  - [ ] NEXT_PUBLIC_SUPABASE_ANON_KEY
- [ ] AI診断機能の無効化確認
  - [ ] NEXT_PUBLIC_AI_DIAGNOSIS=false
- [ ] その他の環境変数

### ドメイン設定
- [ ] カスタムドメインの取得
- [ ] DNS設定
- [ ] SSL証明書の確認

### Supabase 本番環境設定
- [ ] 新規プロジェクト作成（または既存復元）
- [ ] データベースのマイグレーション実行
- [ ] RLSポリシーの確認
- [ ] バックアップ設定

### デプロイ設定
- [ ] 自動デプロイの設定（main ブランチ）
- [ ] プレビューデプロイの設定（PR）
- [ ] ビルドコマンドの確認
- [ ] 出力ディレクトリの確認

### パフォーマンス最適化
- [ ] 画像最適化の確認
- [ ] フォント最適化の確認
- [ ] バンドルサイズの確認
- [ ] Lighthouse スコアの確認

### セキュリティ設定
- [ ] HTTPS強制
- [ ] セキュリティヘッダーの設定
- [ ] CORS設定の確認
- [ ] 環境変数の暗号化確認

## Vercel 設定

### next.config.ts

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // 本番ビルド最適化
  output: 'standalone',

  // 画像最適化
  images: {
    formats: ['image/avif', 'image/webp'],
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**.supabase.co',
      },
    ],
  },

  // セキュリティヘッダー
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on',
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload',
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
        ],
      },
    ];
  },
};

export default nextConfig;
```

### vercel.json

```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["hnd1"],
  "github": {
    "silent": true
  }
}
```

## デプロイチェックリスト

### デプロイ前
- [ ] 全てのテストが通過
- [ ] Lintエラーがない
- [ ] ビルドエラーがない
- [ ] 環境変数が正しく設定されている
- [ ] AI診断機能が無効化されている
- [ ] データベースマイグレーションが適用されている

### デプロイ後
- [ ] サイトが正常に表示される
- [ ] 全ての機能が動作する
- [ ] データベース接続が正常
- [ ] 画像が正しく表示される
- [ ] モバイルで正常に動作する
- [ ] Lighthouse スコアが基準を満たす

### 監視設定
- [ ] Vercel Analytics の有効化
- [ ] エラーログの確認
- [ ] パフォーマンスメトリクスの確認

## Supabase マイグレーション

```sql
-- 本番環境でのマイグレーション実行
-- Supabase Studio の SQL Editor で実行

-- hospitalsテーブル作成
CREATE TABLE IF NOT EXISTS hospitals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  category TEXT[] NOT NULL,
  address TEXT NOT NULL,
  tel TEXT NOT NULL,
  city TEXT NOT NULL,
  opening_hours TEXT,
  google_map_url TEXT,
  note TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- インデックス作成
CREATE INDEX IF NOT EXISTS idx_hospitals_city ON hospitals(city);
CREATE INDEX IF NOT EXISTS idx_hospitals_category ON hospitals USING GIN(category);

-- RLS有効化
ALTER TABLE hospitals ENABLE ROW LEVEL SECURITY;

-- ポリシー作成
CREATE POLICY "Public hospitals are viewable by everyone"
  ON hospitals FOR SELECT
  USING (true);

CREATE POLICY "Authenticated users can insert hospitals"
  ON hospitals FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can update hospitals"
  ON hospitals FOR UPDATE
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can delete hospitals"
  ON hospitals FOR DELETE
  USING (auth.role() = 'authenticated');
```

## 受け入れ基準
- [ ] Vercelへのデプロイが成功している
- [ ] カスタムドメインでアクセスできる
- [ ] HTTPS接続が有効
- [ ] 全ての機能が本番環境で動作する
- [ ] Supabaseとの接続が正常
- [ ] 自動デプロイが設定されている
- [ ] エラー監視が有効

## 依存関係
- 全ての開発チケット完了後

## 関連ファイル
- `/home/masayuki/NextJs/byouin-nabi/next.config.ts`
- `/home/masayuki/NextJs/byouin-nabi/vercel.json`
- Vercel Dashboard
- Supabase Dashboard

## 備考
- デプロイ前にステージング環境でのテストを推奨
- 初回デプロイ後は自動デプロイで継続的にリリース
- ロールバック手順を事前に確認
- バックアップは自動で行われる（Supabase）
