# 010 - CSV/Excelã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½

## æ¦‚è¦
CSV/Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç—…é™¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ç›®çš„
- å¤§é‡ã®ç—…é™¢ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«ç™»éŒ²
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## ã‚¿ã‚¹ã‚¯

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] papaparseï¼ˆCSVè§£æï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] xlsxï¼ˆExcelè§£æï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] å‹å®šç¾©ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### ã‚¤ãƒ³ãƒãƒ¼ãƒˆUI
- [ ] /admin/hospitals/import ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ 
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
- [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³
- [ ] é€²è¡ŒçŠ¶æ³è¡¨ç¤º

### Server Action å®Ÿè£…
- [ ] importHospitals ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
- [ ] CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ
- [ ] Excelãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆå‡¦ç†

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ã‚¨ãƒ©ãƒ¼è¡Œã®å ±å‘Š
- [ ] éƒ¨åˆ†çš„ãªæˆåŠŸå‡¦ç†

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- [ ] CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
- [ ] ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

## CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼

```csv
ç—…é™¢å,è¨ºç™‚ç§‘,ä½æ‰€,é›»è©±ç•ªå·,å¸‚ç”ºæ‘,è¨ºç™‚æ™‚é–“,Google Maps URL,å‚™è€ƒ
ã€‡ã€‡ç—…é™¢,"å†…ç§‘,å¤–ç§‘",é•·é‡çœŒé£¯ç”°å¸‚ã€‡ã€‡ç”º1-2-3,0265-XX-XXXX,é£¯ç”°å¸‚,æœˆ-é‡‘ 9:00-17:00,https://maps.google.com/...,é§è»Šå ´ã‚ã‚Š
```

## å®Ÿè£…ä¾‹

```typescript
// src/app/admin/hospitals/import/actions.ts
'use server';

import { parse } from 'papaparse';
import * as XLSX from 'xlsx';
import { supabase } from '@/lib/supabase';
import { verifyAdminSession } from '@/lib/auth';

interface ImportResult {
  success: number;
  errors: Array<{ row: number; message: string }>;
}

export async function importHospitals(
  formData: FormData
): Promise<ImportResult> {
  const session = await verifyAdminSession();
  if (!session) {
    throw new Error('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
  }

  const file = formData.get('file') as File;
  if (!file) {
    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
  }

  const fileName = file.name.toLowerCase();
  let parsedData: any[] = [];

  // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«ã‚ˆã‚‹è§£æ
  if (fileName.endsWith('.csv')) {
    const text = await file.text();
    const result = parse(text, {
      header: true,
      skipEmptyLines: true,
    });
    parsedData = result.data;
  } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
    const buffer = await file.arrayBuffer();
    const workbook = XLSX.read(buffer);
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    parsedData = XLSX.utils.sheet_to_json(worksheet);
  } else {
    throw new Error('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆCSV, XLSXã®ã¿ï¼‰');
  }

  const result: ImportResult = {
    success: 0,
    errors: [],
  };

  // ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨æŒ¿å…¥
  for (let i = 0; i < parsedData.length; i++) {
    const row = parsedData[i];
    const rowNumber = i + 2; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è€ƒæ…®

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!row['ç—…é™¢å'] || !row['ä½æ‰€'] || !row['é›»è©±ç•ªå·']) {
        throw new Error('å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
      }

      const hospitalData = {
        name: row['ç—…é™¢å'],
        category: row['è¨ºç™‚ç§‘']
          ? row['è¨ºç™‚ç§‘'].split(',').map((s: string) => s.trim())
          : [],
        address: row['ä½æ‰€'],
        tel: row['é›»è©±ç•ªå·'],
        city: row['å¸‚ç”ºæ‘'] || '',
        opening_hours: row['è¨ºç™‚æ™‚é–“'] || null,
        google_map_url: row['Google Maps URL'] || null,
        note: row['å‚™è€ƒ'] || null,
      };

      // ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
      const { error } = await supabase
        .from('hospitals')
        .insert(hospitalData);

      if (error) {
        throw error;
      }

      result.success++;
    } catch (error) {
      result.errors.push({
        row: rowNumber,
        message: error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼',
      });
    }
  }

  return result;
}
```

```typescript
// src/app/admin/hospitals/import/page.tsx
'use client';

import { useState } from 'react';
import { importHospitals } from './actions';

export default function ImportPage() {
  const [file, setFile] = useState<File | null>(null);
  const [isImporting, setIsImporting] = useState(false);
  const [result, setResult] = useState<any>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!file) return;

    setIsImporting(true);
    try {
      const formData = new FormData();
      formData.append('file', file);

      const importResult = await importHospitals(formData);
      setResult(importResult);
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsImporting(false);
    }
  };

  return (
    <div className="max-w-2xl">
      <h1 className="text-2xl font-bold mb-6">ç—…é™¢ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>

      <div className="mb-6">
        <a
          href="/templates/hospitals_template.csv"
          className="text-primary underline"
          download
        >
          ğŸ“¥ CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </a>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label className="block font-medium mb-2">
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆCSV, XLSXï¼‰
          </label>
          <input
            type="file"
            accept=".csv,.xlsx,.xls"
            onChange={(e) => setFile(e.target.files?.[0] || null)}
            className="border rounded px-3 py-2 w-full"
          />
        </div>

        <button
          type="submit"
          disabled={!file || isImporting}
          className="bg-primary text-white px-6 py-2 rounded hover:bg-primary-dark disabled:opacity-50"
        >
          {isImporting ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...' : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ'}
        </button>
      </form>

      {result && (
        <div className="mt-6 p-4 border rounded">
          <h2 className="font-bold text-lg mb-2">ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ</h2>
          <p className="text-green-600">âœ“ æˆåŠŸ: {result.success}ä»¶</p>
          {result.errors.length > 0 && (
            <div className="mt-4">
              <p className="text-red-600 font-bold">
                âœ— ã‚¨ãƒ©ãƒ¼: {result.errors.length}ä»¶
              </p>
              <ul className="mt-2 space-y-1 text-sm">
                {result.errors.map((err: any, idx: number) => (
                  <li key={idx} className="text-red-600">
                    {err.row}è¡Œç›®: {err.message}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## package.json è¿½åŠ 

```json
{
  "dependencies": {
    "papaparse": "^5.4.1",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/papaparse": "^5.3.14"
  }
}
```

## å—ã‘å…¥ã‚ŒåŸºæº–
- [ ] CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹
- [ ] Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å ±å‘Šã•ã‚Œã‚‹
- [ ] æˆåŠŸä»¶æ•°ã¨ã‚¨ãƒ©ãƒ¼ä»¶æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼è¡ŒãŒç‰¹å®šã§ãã‚‹
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹

## ä¾å­˜é–¢ä¿‚
- 009-ç—…é™¢CRUDæ©Ÿèƒ½

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `/home/masayuki/NextJs/byouin-nabi/src/app/admin/hospitals/import/page.tsx`
- `/home/masayuki/NextJs/byouin-nabi/src/app/admin/hospitals/import/actions.ts`
- `/home/masayuki/NextJs/byouin-nabi/public/templates/hospitals_template.csv`

## å‚™è€ƒ
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ100ä»¶ä»¥ä¸Šï¼‰ã®å ´åˆã¯ãƒãƒƒãƒå‡¦ç†ã‚’æ¤œè¨
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤ºã¯å°†æ¥å¯¾å¿œ
- é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã¯å°†æ¥å¯¾å¿œ
